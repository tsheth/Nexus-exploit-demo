import boto3
import time

def lambda_handler(event, context):
    remote = event['url']
    cmd = event['cmd']
    inst_detail = ""
    server = ""
    print("[+] Checking if Content-Selectors exist =>", end=' ')
    try:
        ec2 = boto3.client('ec2')

        if remote == "app.bryceindustries.net":
            server = "Shellshock-Docker-PT-Tejas"
            filters = [{
                'Name': 'tag:Name',
                'Values': ['Shellshock-Docker-PT-Tejas']
            }]
        else:
            server = "Protected-DS-Struts-Docker-tejas"
            filters = [{
                'Name': 'tag:Name',
                'Values': ['Protected-DS-Struts-Docker-tejas']
            }]

        reservations = ec2.describe_instances(Filters=filters)
        print(reservations)
        for instances in reservations['Reservations']:
            for instance in instances['Instances']:
                print(instance['InstanceId'])
                inst_detail=instance['InstanceId']

        ssm = boto3.client('ssm')
        ssm_document = "Inter-container-attack"
        print("ssm variable done")
        cmd_details = ssm.send_command(
            Targets=[
                {
                    'Key': 'tag:Name',
                    'Values': [server]
                }
            ],
            DocumentName=ssm_document,
            Comment='east-west traffic exploit',
            Parameters={
                'cmd': [
                    cmd
                ]
            }
        )
        cmd_id = cmd_details["Command"]["CommandId"]

        print(cmd_id)
        time.sleep(10)
        output = ssm.get_command_invocation(CommandId=cmd_id, InstanceId=inst_detail)
        print(output)
        print("Command executed from vulnerable Container to Victim container")
        if output['StandardOutputContent'] != "":
            var_return = output['StandardOutputContent']
        else:
            var_return = "Container Exploit Failed with exception!!"

        return var_return

    except Exception as e:
        print("Exiting... Target is not exploitable" + str(e))

        var_return = "FAILURE!!! Exploit has failed to execute exploit. east west traffic in victim container is protected"
        return var_return


